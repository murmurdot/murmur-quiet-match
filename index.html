<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>murmur — quiet match</title>
  <meta name="description" content="Calm endless mode & stage-based challenge. Minimal café-vibe match-3 with sweets." />
  <style>
    :root{
      --bg:#fafafa; --ink:#1a1a1a; --soft:#ececec; --line:#e7e7e7; --muted:#6b7280;
      --tile:64px; --shadow:0 10px 30px rgba(0,0,0,.08);
      --yt-bg:#e1ebff; --yt-border:#9fb8ff; --yt-text:#0b3d91;
      --yt-bg-hov:#d1e0ff; --yt-border-hov:#86a8ff; --yt-text-hov:#09306f;
      --start-border:#d1d5db; --start-border-hov:#cbd5e1; --start-bg:#fff; --start-bg-hov:#f7f7f7;
      --cat-w:260px; --grid-gap:10px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1120px;margin:0 auto;padding:12px}
    .card{background:#fff;border:1px solid var(--line);border-radius:24px;box-shadow:var(--shadow)}

    header{display:flex;align-items:center;justify-content:center;gap:16px;padding:18px 12px 8px}
    header img{height:64px;width:auto;cursor:pointer}
    .brand-fallback{font-weight:700;letter-spacing:.02em;opacity:.9;text-align:center;padding:8px 12px;border:1px dashed var(--line);border-radius:12px;background:#fff}

    #start{min-height:68vh}
    #start .inner{display:flex;flex-direction:column;gap:16px;align-items:center;justify-content:center;padding:30px}
    .title{font-size:28px;font-weight:700;letter-spacing:.06em;text-align:center}
    .subtitle{opacity:.75;text-align:center}

    .badges{display:flex;gap:8px;justify-content:center}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:700;font-size:.82rem;border:1px solid}
    .badge.free{background:#ecfdf5;border-color:#a7f3d0;color:#065f46}

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center}
    .seg{display:flex;background:var(--soft);border-radius:999px;padding:4px}
    .seg button{appearance:none;border:none;background:transparent;border-radius:999px;padding:8px 14px;cursor:pointer}
    .seg button[aria-pressed="true"]{background:#111;color:#fff;box-shadow:var(--shadow)}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:999px;padding:10px 14px;cursor:pointer;transition:transform .06s}
    .btn:hover{transform:translateY(-1px)}

    .note{color:#444;font-size:.92rem;line-height:1.65;text-align:left;max-width:860px;margin:0 auto}
    .note small{display:block;color:#666;margin-top:6px;text-align:center}

    a.linkbtn, button.linkbtn{
      appearance:none; -webkit-appearance:none;
      display:inline-flex; flex-direction:column; align-items:center; gap:2px;
      padding:12px 18px; border-radius:999px; text-decoration:none;
      font-weight:700; box-shadow:0 2px 8px rgba(0,0,0,.06);
      transition:background .2s, border-color .2s, color .2s, transform .06s;
      text-align:center; line-height:1.15;
    }
    .linkbtn .line1{display:block;font-weight:800}
    .linkbtn .line2{display:block;font-weight:600;opacity:.9;font-size:.85em;line-height:1.2;margin-top:1px}

    a.linkbtn, button.linkbtn{ background:var(--yt-bg); border:1px solid var(--yt-border); color:var(--yt-text); }
    a.linkbtn:hover, button.linkbtn:hover{ transform:translateY(-1px); background:var(--yt-bg-hov); border-color:var(--yt-border-hov); color:var(--yt-text-hov); }
    a.linkbtn:link, a.linkbtn:visited{ color:var(--yt-text); }

    button.linkbtn.btn-start{ background:var(--start-bg); border:1px solid var(--start-border); color:#111; box-shadow:0 2px 6px rgba(0,0,0,.05); }
    button.linkbtn.btn-start:hover{ background:var(--start-bg-hov); border-color:var(--start-border-hov); }

    .cat-small{width:var(--cat-w);height:auto;opacity:.98}

    /* Optional affiliate (hidden until href is real) */
    .sponsor{margin-top:2px}
    .sponsor[hidden]{display:none!important}
    .affi{display:inline-flex;align-items:center;gap:6px;font-size:.82rem;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;color:#333;text-decoration:none}
    .affi:hover{transform:translateY(-1px)}

    #game{display:none}
    .top{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid var(--line)}
    .top .left,.top .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{border:1px solid var(--line);background:#fff;border-radius:999px;padding:10px 14px;min-width:90px;text-align:center}

    #board-wrap{padding:16px;display:flex;justify-content:center;position:relative;overflow:hidden}
    #board{display:grid;gap:var(--grid-gap,10px);padding:12px;background:linear-gradient(180deg,#fff,#f7f7f7);border:1px solid var(--line);border-radius:24px;box-shadow:var(--shadow)}
    .cell{width:var(--tile);height:var(--tile);border-radius:18px;display:grid;place-items:center;background:#fff;border:1px solid var(--line);position:relative;overflow:hidden}
    .cell img{width:90%;height:90%;object-fit:contain;pointer-events:none;user-select:none}
    .cell.selected{outline:3px solid #111}
    .cell.matching{animation:pop .32s ease}
    @keyframes pop{0%{transform:scale(.95);opacity:.7}100%{transform:scale(1);opacity:1}}

    .footer{padding:10px 16px;border-top:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .muted{opacity:.65}

    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#111;color:#fff;padding:10px 14px;border-radius:999px;opacity:0;transition:opacity .2s,transform .2s;pointer-events:none;z-index:60}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-3px)}

    /* Combo element is present but never shown (disabled in JS) */
    #combo{display:none}
  </style>
</head>
<body>
  <header class="wrap" style="justify-content:center">
    <img id="bannerImg" src="assets/images/banner.png?v=20250811j" alt="murmur banner" />
    <div id="brandFallback" class="brand-fallback" hidden>murmur. relaxing games — quiet match</div>
  </header>

  <section id="start" class="wrap card">
    <div class="inner">
      <div class="title">quiet match</div>
      <div class="subtitle">choose your mode, then start.</div>
      <div class="badges"><span class="badge free">free to play</span></div>

      <div class="row" aria-label="Mode">
        <div class="seg" id="modeSeg">
          <button type="button" data-mode="calm" aria-pressed="true">Calm</button>
          <button type="button" data-mode="challenge" aria-pressed="false">Challenge</button>
        </div>
      </div>

      <div class="row">
        <button class="linkbtn btn-start" id="startBtn"><span class="line1"><strong>Start</strong></span></button>
      </div>

      <div class="note">
        <strong>Calm</strong>: Match <em>3 or more</em> identical pieces to clear — relaxed endless play.<br/>
        <strong>Challenge</strong>: Stage-based with move limit & target score.<br/>
        Clear a stage to unlock the next (100 stages).
        <small>
          <strong>Save</strong>: Progress and settings are saved in your browser (local storage).<br/>
          They may reset on different devices/browsers, private/incognito mode, or when clearing site data.<br/>
          <strong>Recommended</strong>: Latest Chrome / Edge / Firefox / Safari on desktop or tablet.
        </small>
      </div>

      <div class="row">
        <a class="linkbtn" href="https://www.youtube.com/channel/UCxXav6WmZ-EhWB3zbIRxFMg" target="_blank" rel="noopener" title="murmur. on YouTube">
          <span class="line1">murmur. on YouTube</span>
          <span class="line2">listen to more music</span>
        </a>
        <img class="cat-small" src="assets/images/welcome_cat.png?v=20250811j" alt="cat" />
      </div>

      <!-- Optional affiliate (hidden until href is real) -->
      <div class="sponsor" id="sponsor" hidden>
        <a class="affi" id="affiLink" href="#" target="_blank" rel="sponsored nofollow noopener">Support (affiliate)</a>
      </div>
    </div>
  </section>

  <section id="game" class="wrap card" aria-live="polite">
    <div class="ytbar row" style="justify-content:center;padding:10px 0 0;">
      <a class="linkbtn" href="https://www.youtube.com/channel/UCxXav6WmZ-EhWB3zbIRxFMg" target="_blank" rel="noopener" title="murmur. on YouTube">
        <span class="line1">murmur. on YouTube</span>
        <span class="line2">listen to more music</span>
      </a>
    </div>

    <div class="top">
      <div class="left">
        <div class="pill">Score: <span id="score">0</span></div>
        <div class="pill" id="movesWrap" hidden>Moves left: <span id="moves">0</span></div>
        <div class="pill" id="stageInfo" hidden>Stage: <span id="stage">1</span> · Target: <span id="target">0</span></div>
      </div>
      <div class="right">
        <div class="seg" id="paceSeg2">
          <button type="button" data-pace="slow" aria-pressed="true">Slow</button>
          <button type="button" data-pace="normal" aria-pressed="false">Normal</button>
          <button type="button" data-pace="fast" aria-pressed="false">Fast</button>
        </div>
        <button class="btn" id="musicBtn" aria-pressed="false">Music: Off</button>
        <button class="btn" id="sfxBtn" aria-pressed="true">SFX: On</button>
        <label class="row" style="gap:6px;margin-left:6px">Music Vol <input id="vol2" type="range" min="0" max="1" step="0.01" value="0.7" /></label>
        <button class="btn" id="restartBtn">Restart</button>
        <button class="btn" id="stageSelectBtn" hidden>Stage Select</button>
        <button class="btn" id="backBtn">Home</button>
      </div>
    </div>

    <div id="board-wrap">
      <div id="combo" aria-live="polite"></div>
      <div id="board" role="grid" aria-label="Match board"></div>
    </div>

    <div class="footer">
      <div class="muted">murmur · calm sweets match</div>
      <div class="muted" id="status"></div>
    </div>
  </section>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>
  <div class="overlay" id="overlay"><div class="sheet" id="sheet"></div></div>

  <script>
  (function(){ 'use strict';
    var IMG_VER='?v=20250811j';
    var TILE_IMAGES=[
      'assets/images/lemon_soda_tile.png'+IMG_VER,
      'assets/images/cafelatte_tile.png'+IMG_VER,
      'assets/images/strawberry_tart_tile.png'+IMG_VER,
      'assets/images/caramelpudding_tile.png'+IMG_VER,
      'assets/images/violet_soda_tile.png'+IMG_VER,
      'assets/images/vanilla_macaron_tile.png'+IMG_VER
    ];

    var SFX={choice:new Audio('assets/audio/choice.mp3'),match:new Audio('assets/audio/match.mp3')};
    try{ Object.values(SFX).forEach(function(a){ a.preload='auto'; }); }catch(_){}
    var BGMS=['assets/audio/match_game_bgm_1.mp3','assets/audio/match_game_bgm_2.mp3','assets/audio/match_game_bgm_3.mp3','assets/audio/match_game_bgm_4.mp3','assets/audio/match_game_bgm_5.mp3'];
    var music=new Audio(); music.loop=false;
    var currentBgm=-1, musicEnabled=false, sfxEnabled=true;

    var startSec=document.getElementById('start');
    var gameSec=document.getElementById('game');
    var boardWrap=document.getElementById('board-wrap');
    var boardEl=document.getElementById('board');
    var toastEl=document.getElementById('toast');
    var comboEl=document.getElementById('combo');
    var scoreEl=document.getElementById('score');
    var movesWrap=document.getElementById('movesWrap');
    var movesEl=document.getElementById('moves');
    var stageInfo=document.getElementById('stageInfo');
    var stageEl=document.getElementById('stage');
    var targetEl=document.getElementById('target');
    var statusEl=document.getElementById('status');
    var modeSeg=document.getElementById('modeSeg');
    var startBtn=document.getElementById('startBtn');
    var paceSeg2=document.getElementById('paceSeg2');
    var musicBtn=document.getElementById('musicBtn');
    var sfxBtn=document.getElementById('sfxBtn');
    var vol2=document.getElementById('vol2');
    var restartBtn=document.getElementById('restartBtn');
    var stageSelBtn=document.getElementById('stageSelectBtn');
    var backBtn=document.getElementById('backBtn');
    var banner=document.getElementById('bannerImg');
    var sponsor=document.getElementById('sponsor');
    var affiLink=document.getElementById('affiLink');

    if(banner){
      banner.addEventListener('error',function(){
        banner.style.display='none';
        var fb=document.getElementById('brandFallback'); if(fb) fb.hidden=false;
      });
      banner.addEventListener('click',function(){ goToStart(); });
    }

    function pickNextBgm(){ var i; do{ i=Math.floor(Math.random()*BGMS.length);}while(i===currentBgm && BGMS.length>1); currentBgm=i; music.src=BGMS[i]; }
    function startMusic(){ if(!musicEnabled){ musicEnabled=true; pickNextBgm(); music.play().catch(function(){});} updateAudioButtons(); syncVol(); }
    function stopAllAudio(){
      musicEnabled=false; music.pause();
      try{ Object.values(SFX).forEach(function(a){ a.pause(); a.currentTime=0; }); }catch(_){}
      updateAudioButtons();
    }
    music.addEventListener('ended',function(){ if(musicEnabled){ pickNextBgm(); music.play().catch(function(){}); }});
    function playSfx(name){ if(!sfxEnabled) return; try{ var a=SFX[name]; a.currentTime=0; a.play().catch(function(){});}catch(_){} }
    function updateAudioButtons(){
      function s(btn,on,l){ if(!btn) return; btn.setAttribute('aria-pressed',String(on)); btn.textContent=l+(on?': On':': Off'); }
      s(musicBtn,musicEnabled,'Music'); s(sfxBtn,sfxEnabled,'SFX');
    }
    function syncVol(){ if(music) music.volume=Number((vol2&&vol2.value)||'0.7'); }
    if(musicBtn){ musicBtn.addEventListener('click',function(){ musicEnabled? stopAllAudio(): startMusic(); }); }
    if(sfxBtn){ sfxBtn.addEventListener('click',function(){ sfxEnabled=!sfxEnabled; updateAudioButtons(); }); }
    if(vol2){ vol2.addEventListener('input',syncVol); }

    document.addEventListener('visibilitychange',function(){ if(document.hidden){ stopAllAudio(); } });

    var mode='calm', pace='slow';
    function setMode(m){ mode=m; if(modeSeg){ var bs=modeSeg.querySelectorAll('button'); for(var i=0;i<bs.length;i++){ var b=bs[i]; b.setAttribute('aria-pressed', String(b.getAttribute('data-mode')===mode)); } } }
    if(modeSeg){
      modeSeg.addEventListener('click',function(e){
        var b=e.target && e.target.closest ? e.target.closest('button') : e.target;
        if(!b || b.tagName!=='BUTTON') return;
        setMode(b.getAttribute('data-mode'));
      });
    }
    function setPaceInGame(p){ pace=p; if(paceSeg2){ var bs=paceSeg2.querySelectorAll('button'); for(var i=0;i<bs.length;i++){ var b=bs[i]; b.setAttribute('aria-pressed', String(b.getAttribute('data-pace')===pace)); } } }
    if(paceSeg2){
      paceSeg2.addEventListener('click',function(e){
        var b=e.target && e.target.closest ? e.target.closest('button') : e.target;
        if(!b || b.tagName!=='BUTTON') return;
        setPaceInGame(b.getAttribute('data-pace'));
      });
    }
    function paceFactor(){ return pace==='slow'?1.8 : pace==='normal'?1.3 : 1.05; }

    if(startBtn){
      startBtn.addEventListener('click',function(){
        var ref=document.referrer||'';
        var isYT=/youtube\.com|youtu\.be/.test(ref) || (function(){ try{ return (new URLSearchParams(location.search)).get('yt')==='1'; }catch(_){ return false; }})();
        if(isYT){
          var url=new URL(location.href);
          url.searchParams.set('play','1'); url.searchParams.set('mode',mode);
          window.open(url.toString(),'_blank');
        }else{
          startGameAuto(mode);
        }
      });
    }
    (function autoStart(){ try{ var p=new URLSearchParams(location.search); if(p.get('play')==='1'){ var m=p.get('mode')||'calm'; setMode(m); startGameAuto(m); } }catch(_){}})();

    var rows=8, cols=8, grid=[], selected=null, busy=false, score=0, comboStep=0, comboTotal=0;
    var cancelled=false;

    function createBoardDom(){
      boardEl.style.gridTemplateColumns='repeat('+cols+', var(--tile))';
      boardEl.innerHTML='';
      for(var r=0;r<rows;r++) for(var c=0;c<cols;c++){
        var cell=document.createElement('div'); cell.className='cell'; cell.dataset.r=r; cell.dataset.c=c;
        cell.addEventListener('click',onCellClick);
        var img=document.createElement('img'); img.alt='';
        cell.appendChild(img); boardEl.appendChild(cell);
      }
    }
    function getCell(r,c){ return boardEl.children[r*cols+c]; }
    function setCellImage(r,c){
      var idx=grid[r][c]; var cell=getCell(r,c); var img=cell.querySelector('img');
      if(idx>=0){ img.src=TILE_IMAGES[idx]; cell.style.visibility='visible'; }
      else { img.removeAttribute('src'); cell.style.visibility='hidden'; }
    }
    function renderAll(){ for(var r=0;r<rows;r++) for(var c=0;c<cols;c++) setCellImage(r,c); }
    function randInt(n){ return Math.floor(Math.random()*n); }
    function randTileFor(r,c){
      var ch=[0,1,2,3,4,5];
      var L1=(c>=1)?grid[r][c-1]:-99, L2=(c>=2)?grid[r][c-2]:-98;
      var U1=(r>=1)?grid[r-1][c]:-97, U2=(r>=2)?grid[r-2][c]:-96;
      ch=ch.filter(function(x){ return !((x===L1&&x===L2)||(x===U1&&x===U2)); });
      if(!ch.length) ch=[0,1,2,3,4,5];
      return ch[randInt(ch.length)];
    }

    function generateInitialGrid(){
      grid=Array.from({length:rows},function(){ return Array(cols).fill(0); });
      for(var r=0;r<rows;r++) for(var c=0;c<cols;c++) grid[r][c]=randTileFor(r,c);
      var guard=0;
      while( (findMatches().size>0) || !hasAnyMoves() ){
        for(r=0;r<rows;r++) for(c=0;c<cols;c++) grid[r][c]=randTileFor(r,c);
        if(++guard>160) break;
      }
    }
    function reshuffle(){
      var flat=grid.flat();
      for(var i=flat.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=flat[i]; flat[i]=flat[j]; flat[j]=t; }
      for(var r=0;r<rows;r++) for(var c=0;c<cols;c++) grid[r][c]=flat[r*cols+c];
      renderAll();
    }

    function onCellClick(e){
      if(busy) return;
      var r=+e.currentTarget.dataset.r, c=+e.currentTarget.dataset.c;
      if(selected && selected.r===r && selected.c===c){ getCell(r,c).classList.remove('selected'); selected=null; return; }
      if(!selected){ selected={r:r,c:c}; getCell(r,c).classList.add('selected'); playSfx('choice'); return; }
      var sr=selected.r, sc=selected.c;
      if(Math.abs(sr-r)+Math.abs(sc-c)!==1){ getCell(sr,sc).classList.remove('selected'); selected={r:r,c:c}; getCell(r,c).classList.add('selected'); playSfx('choice'); return; }
      swapAndResolve(sr,sc,r,c);
    }
    function swapValues(a,b,c,d){ var t=grid[a][b]; grid[a][b]=grid[c][d]; grid[c][d]=t; setCellImage(a,b); setCellImage(c,d); }
    function findMatches(){
      var matched=new Set();
      var seen=Array.from({length:rows},function(){ return Array(cols).fill(false); });
      var dirs=[[1,0],[-1,0],[0,1],[0,-1]];
      function inb(r,c){ return r>=0&&r<rows&&c>=0&&c<cols; }
      for(var r=0;r<rows;r++) for(var c=0;c<cols;c++){
        if(seen[r][c]) continue; var val=grid[r][c];
        if(val===-1){ seen[r][c]=true; continue; }
        var q=[[r,c]]; seen[r][c]=true; var comp=[[r,c]];
        while(q.length){
          var cur=q.shift(); var rr=cur[0], cc=cur[1];
          for(var di=0;di<dirs.length;di++){
            var dr=dirs[di][0], dc=dirs[di][1]; var nr=rr+dr, nc=cc+dc;
            if(!inb(nr,nc)||seen[nr][nc]) continue;
            if(grid[nr][nc]===val){ seen[nr][nc]=true; q.push([nr,nc]); comp.push([nr,nc]); }
          }
        }
        if(comp.length>=3) comp.forEach(function(p){ matched.add(p[0]+','+p[1]); });
      }
      return matched;
    }
    function hasAnyMoves(){
      for(var r=0;r<rows;r++) for(var c=0;c<cols;c++){
        var here=grid[r][c];
        var trySwap=function(r2,c2){
          if(r2<0||r2>=rows||c2<0||c2>=cols) return false;
          var t=grid[r2][c2]; if(t===here) return false;
          grid[r][c]=t; grid[r2][c2]=here; var ok=findMatches().size>0; grid[r][c]=here; grid[r2][c2]=t; return ok;
        };
        if(trySwap(r,c+1) || trySwap(r+1,c)) return true;
      }
      return false;
    }

    async function swapAndResolve(r1,c1,r2,c2){
      busy=true; comboStep=0; comboTotal=0;
      playSfx('choice'); getCell(r1,c1).classList.remove('selected'); selected=null;
      swapValues(r1,c1,r2,c2); await delay(120);
      var m=findMatches(); if(m.size===0){ swapValues(r1,c1,r2,c2); busy=false; return; }
      if(mode==='challenge'){ movesLeft--; updateHud(); }
      await resolveMatches(m); busy=false;
      if(!hasAnyMoves()){ reshuffle(); showToast('No moves — reshuffling'); }
    }

    function delay(ms){ return new Promise(function(res){ setTimeout(res, ms*paceFactor()); }); }
    function updateHud(){ movesEl.textContent=movesLeft; stageEl.textContent=currentStage; targetEl.textContent=targetScore; scoreEl.textContent=score; }

    var SHOW_COMBO=false;
    async function resolveMatches(matchedSet){
      if(cancelled) return;
      comboStep++;
      if(SHOW_COMBO){ /* combo表示は無効化中 */ }

      matchedSet.forEach(function(k){ var p=k.split(','); var r=+p[0], c=+p[1]; getCell(r,c).classList.add('matching'); });
      await delay(260); if(cancelled) return;
      matchedSet.forEach(function(k){ var p=k.split(','); var r=+p[0], c=+p[1]; grid[r][c]=-1; setCellImage(r,c); });
      playSfx('match');

      var base=matchedSet.size*10; var add=base;
      if(mode==='calm'){
        var chainBonus = base * Math.max(0, comboStep-1) * 0.06;
        add = Math.round(base + chainBonus);
      }
      score += add; updateHud();

      for(var c=0;c<cols;c++){
        var wr=rows-1;
        for(var r=rows-1;r>=0;r--){ if(grid[r][c]!==-1){ grid[wr][c]=grid[r][c]; wr--; } }
        for(r=wr;r>=0;r--) grid[r][c]=-1;
      }
      renderAll(); await delay(240); if(cancelled) return;

      for(var r=0;r<rows;r++) for(var c=0;c<cols;c++) if(grid[r][c]===-1){ grid[r][c]=randTileFor(r,c); setCellImage(r,c); }
      await delay(200); if(cancelled) return;

      var more=findMatches();
      if(more.size>0){ await resolveMatches(more); }
      else {
        comboStep=0; comboTotal=0;
        if(mode==='challenge'){
          if(score>=targetScore){ onStageClear(); }
          else if(movesLeft<=0){ onStageFail(); }
        }
      }
    }

    var currentStage=1;
    var unlocked=parseInt(localStorage.getItem('mmq_unlocked')||'1',10); if(!(unlocked>=1&&unlocked<=100)) unlocked=1;
    var savedStage=parseInt(localStorage.getItem('mmq_currentStage')||String(unlocked),10); if(!(savedStage>=1&&savedStage<=unlocked)) savedStage=unlocked;
    var targetScore=0, movesLeft=0;
    function stageConfig(n){ var baseTarget=450, grow=50; var baseMoves=20, stepEvery=10, minMoves=15; var moves=Math.max(minMoves, baseMoves - Math.floor((n-1)/stepEvery)); var target=baseTarget + grow*(n-1); return {moves:moves,target:target}; }

    function openStageSelect(){
      var max=100, gridHtml='';
      for(var i=1;i<=max;i++){
        var lock=i>unlocked, cleared=i<unlocked;
        gridHtml+='<div class="stage '+(lock?'lock':'')+' '+(cleared?'clear':'')+'" data-n="'+i+'">'+i+'</div>';
      }
      showOverlay(
        '<button class="close" id="closeOv">×</button>'+
        '<h2>Challenge — Stage Select</h2>'+
        '<div class="muted" style="margin:4px 0 8px">Choose a stage to play. Cleared stages are marked; locked stages unlock as you progress.</div>'+
        '<div class="stage-grid">'+gridHtml+'</div>'
      );
      var closeOv=document.getElementById('closeOv'); if(closeOv) closeOv.onclick=hideOverlay;
      var nodes=document.querySelectorAll('.stage'); for(var j=0;j<nodes.length;j++){
        nodes[j].onclick=function(){ var n=+this.getAttribute('data-n'); if(n>unlocked) return; hideOverlay(); startStage(n); };
      }
    }

    function startStage(n){
      mode='challenge'; setMode('challenge'); currentStage=n;
      var cfg=stageConfig(n); targetScore=cfg.target; movesLeft=cfg.moves;
      startGame(); stageSelBtn.hidden=false; stageInfo.hidden=false; movesWrap.hidden=false;
      updateHud(); localStorage.setItem('mmq_currentStage', String(currentStage));
    }

    function onStageClear(){
      if(unlocked<currentStage+1){ unlocked=currentStage+1; localStorage.setItem('mmq_unlocked', String(unlocked)); }
      showOverlay(
        '<button class="close" id="closeOv">×</button>'+
        '<h2>Stage '+currentStage+' — Cleared 🎉</h2>'+
        '<p class="muted">Score '+score+' / Target '+targetScore+'</p>'+
        '<div class="row" style="justify-content:center">'+
          '<button class="btn" id="next">Next</button>'+
          '<button class="btn" id="select">Stage Select</button>'+
          '<button class="btn" id="retry">Retry</button>'+
        '</div>'
      );
      var closeOv=document.getElementById('closeOv'); if(closeOv) closeOv.onclick=hideOverlay;
      var next=document.getElementById('next'); if(next) next.onclick=function(){ hideOverlay(); startStage(Math.min(100,currentStage+1)); };
      var sel=document.getElementById('select'); if(sel) sel.onclick=function(){ openStageSelect(); };
      var retry=document.getElementById('retry'); if(retry) retry.onclick=function(){ hideOverlay(); startStage(currentStage); };
    }

    function onStageFail(){
      showOverlay(
        '<button class="close" id="close">×</button>'+
        '<h2>Stage '+currentStage+' — Try again</h2>'+
        '<p class="muted">Score '+score+' / Target '+targetScore+'</p>'+
        '<div class="row" style="justify-content:center">'+
          '<button class="btn" id="retry">Retry</button>'+
          '<button class="btn" id="select">Stage Select</button>'+
        '</div>'
      );
      var close=document.getElementById('close'); if(close) close.onclick=hideOverlay;
      var retry=document.getElementById('retry'); if(retry) retry.onclick=function(){ hideOverlay(); startStage(currentStage); };
      var sel=document.getElementById('select'); if(sel) sel.onclick=function(){ openStageSelect(); };
    }

    var overlay=document.getElementById('overlay'); var sheet=document.getElementById('sheet');
    function showOverlay(html){ sheet.innerHTML=html; overlay.classList.add('show'); }
    function hideOverlay(){ overlay.classList.remove('show'); sheet.innerHTML=''; }

    function showResumeDialog(){
      var resumeStage = savedStage || unlocked || 1;
      showOverlay(
        '<button class="close" id="closeOv">×</button>'+
        '<h2>Challenge — Continue?</h2>'+
        '<p class="muted">Resume from your last unfinished stage, or start from Stage 1.</p>'+
        '<div class="row" style="justify-content:center">'+
          '<button class="btn" id="resume">Resume (Stage '+resumeStage+')</button>'+
          '<button class="btn" id="fromStart">Start from Stage 1</button>'+
        '</div>'
      );
      var closeOv=document.getElementById('closeOv'); if(closeOv) closeOv.onclick=hideOverlay;
      var resume=document.getElementById('resume'); if(resume) resume.onclick=function(){ hideOverlay(); startStage(resumeStage); };
      var fromStart=document.getElementById('fromStart'); if(fromStart) fromStart.onclick=function(){ hideOverlay(); localStorage.setItem('mmq_currentStage','1'); startStage(1); };
    }

    function startGame(){ startSec.style.display='none'; gameSec.style.display='block'; initGame(); updateAudioButtons(); syncVol(); fitBoard(); }
    function goToStart(){
      cancelled=true; busy=false; selected=null; stopAllAudio();
      gameSec.style.display='none'; startSec.style.display='block'; statusEl.textContent='';
      if(comboEl){ comboEl.textContent=''; comboEl.classList.remove('show'); }
    }

    function initGame(){
      cancelled=false; score=0; selected=null; busy=false; comboStep=0; comboTotal=0;
      createBoardDom(); generateInitialGrid(); renderAll(); fitBoard();
    }

    function startGameAuto(m){ if(m==='challenge'){ if(unlocked>1){ showResumeDialog(); } else { startStage(1); } } else { mode='calm'; setMode('calm'); startGame(); } }

    if(backBtn){
      backBtn.addEventListener('click',function(){
        showOverlay(
          '<button class="close" id="closeOv">×</button>'+
          '<h2>Leave game?</h2>'+
          '<p class="muted">Current in-progress board will reset. Continue?</p>'+
          '<div class="row" style="justify-content:center">'+
            '<button class="btn" id="leave">Home</button>'+
            '<button class="btn" id="stay">Cancel</button>'+
          '</div>'
        );
        var closeOv=document.getElementById('closeOv'); if(closeOv) closeOv.onclick=hideOverlay;
        var leave=document.getElementById('leave'); if(leave) leave.onclick=function(){ hideOverlay(); goToStart(); };
        var stay=document.getElementById('stay'); if(stay) stay.onclick=function(){ hideOverlay(); };
      });
    }
    if(restartBtn){ restartBtn.addEventListener('click',function(){ initGame(); }); }
    if(stageSelBtn){ stageSelBtn.addEventListener('click',function(){ openStageSelect(); }); }

    function showToast(text){
      toastEl.textContent=text; toastEl.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t=setTimeout(function(){ toastEl.classList.remove('show'); },1600);
    }

    function fitBoard(){
      try{
        if (gameSec.style.display !== 'block') return;
        var rect = boardWrap.getBoundingClientRect();
        var wrapW = rect.width || 0;
        if (!wrapW || wrapW < 120) { setTimeout(fitBoard, 16); return; }

        var csBoard = window.getComputedStyle(boardEl);
        var padL = parseFloat(csBoard.paddingLeft)||12;
        var padR = parseFloat(csBoard.paddingRight)||12;
        var gap = (wrapW < 520 ? 6 : 10);
        var isDesktop = window.matchMedia && window.matchMedia('(min-width: 900px)').matches;

        var tile = isDesktop ? 64 : Math.floor((wrapW - padL - padR - (cols-1)*gap) / cols);
        if (!isFinite(tile)) tile = 48;
        tile = Math.max(32, Math.min(64, tile));

        document.documentElement.style.setProperty('--grid-gap', gap+'px');

        var fits = function(){
          var cs = window.getComputedStyle(boardEl);
          var g = parseFloat(cs.gap)||gap;
          var w = cols*tile + (cols-1)*g + padL + padR;
          return w <= wrapW - 1;
        };
        while(!fits() && tile > 28){ tile--; }

        document.documentElement.style.setProperty('--tile', tile+'px');
        boardEl.style.gridTemplateColumns = 'repeat('+cols+', var(--tile))';
      }catch(_){}
    }

    (function preload(){
      try{
        TILE_IMAGES.concat(['assets/images/banner.png'+IMG_VER,'assets/images/welcome_cat.png'+IMG_VER])
          .forEach(function(src){ var im=new Image(); im.src=src; });
        Object.values(SFX).forEach(function(a){ a.load(); });
        pickNextBgm();
      }catch(_){}
    })();

    window.addEventListener('resize', fitBoard, {passive:true});
    window.addEventListener('load', function(){
      if (gameSec.style.display === 'block' && boardEl.children.length === 0) { initGame(); }
      fitBoard();
    }, {passive:true});
    window.addEventListener('pageshow', function(){
      if (gameSec.style.display === 'block' && boardEl.children.length === 0) { initGame(); }
      setTimeout(fitBoard, 60);
    }, {passive:true});
    if (window.ResizeObserver && boardWrap){
      new ResizeObserver(function(){ fitBoard(); }).observe(boardWrap);
    }

    // Auto-show affiliate if href is real
    if(sponsor && affiLink && affiLink.getAttribute('href') && affiLink.getAttribute('href')!=='#'){
      sponsor.hidden=false;
    }

    // keep API surface
    function addCombo(){ /* disabled */ }

  })();
  </script>
</body>
</html>

